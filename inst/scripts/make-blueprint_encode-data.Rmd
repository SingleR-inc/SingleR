---
title: "Obtaining reference data from Blueprint and ENCODE"
author: "Friederike DÃ¼ndar"
date: "8/9/2019"
output: html_document
---

```{r setup, include=FALSE}
library(BiocStyle)
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```

Dvir Aran's original `r Githubpkg("dviraran/SingleR")` github repository contains Robjects with **normalized expression values from reference data sets** such as those collected by Blueprint & Encode, the Human Primary Cell Atlas (HPCA), and the Immunological Genome Project (ImmGen).
These expression data are based on bulk RNA-seq or microarrays from purified cell populations or single-cell RNA-seq of individual tissues.
Every sample represents the transcriptome of a specific cell type; this data is therefore well suited to be used as a general training data set for the typical `SingleR` analysis.

For now, we're going to retrieve the processed data from the legacy `SingleR` repository:

```{r retrieve_from_github}
dataset <- "blueprint_encode" 
full.url <- sprintf("https://github.com/dviraran/SingleR/blob/master/data/%s.rda?raw=true", dataset)
bfc <- BiocFileCache::BiocFileCache(ask=FALSE)
ref <- BiocFileCache::bfcrpath(bfc, full.url)
env <- new.env()
load(ref, envir = env)
ref.set <- get(dataset, envir = env)
```

The original objects contain numerous nested lists.
We only need the matrix of normalized expression values and the labels assigned to
each sample/cell.

Extract the normalized expression matrix:

```{r get_logcounts}
logcounts <- ref.set$data
```

There's a problem with the naming of the samples -- there's a duplicated name:

```{r}
table(duplicated(colnames(logcounts)))
```

Uniquifying the colnames:

```{r}
colnames(logcounts) <- paste(colnames(logcounts), 1:ncol(logcounts), sep = ".")
```

Extract cell labels, which represent the metadata:

```{r get_coldata}
coldata <- S4Vectors::DataFrame(row.names = colnames(logcounts),
                       label.main = ref.set$main_types,
                       label.fine = ref.set$types)
```

Saving counts and metadata to upload them to `r Biocpkg("ExperimentHub")`.

```{r save_for_ExpHub}
path <- file.path("SingleR", dataset)
dir.create(path, showWarnings = FALSE, recursive = TRUE)

## saving counts
saveRDS(logcounts, file = file.path(path, "logcounts.rds", "1.0.0"))

## saving metadata
saveRDS(coldata, file = file.path(path, "coldata.rds", "1.0.0") )
```
